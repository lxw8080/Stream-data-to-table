# 客户类型标记工具 - 文件说明

## 📁 新增文件列表

### 核心文件

#### 1. `mark_customer_type.py`
**主程序文件**
- 功能：客户类型标记的核心逻辑
- 类型：Python脚本
- 用途：
  - 读取Excel文件
  - 分析客户数据
  - 标记新增/存量客户
  - 应用颜色格式
  - 保存结果

**主要类和方法：**
```python
class CustomerTypeMarker:
    - load_data()           # 加载Excel数据
    - validate_columns()    # 验证列结构
    - mark_customer_types() # 标记客户类型
    - apply_formatting()    # 应用颜色格式
    - save_file()          # 保存文件
    - process()            # 执行完整流程
```

---

#### 2. `mark_customer.bat`
**Windows批处理文件**
- 功能：一键运行标记工具
- 类型：批处理脚本
- 用途：双击即可处理 `租机登记表.xlsx`
- 特点：
  - 自动设置UTF-8编码
  - 显示处理进度
  - 处理完成后暂停，方便查看结果

---

### 文档文件

#### 3. `客户类型标记说明.md`
**详细使用说明文档**
- 内容包括：
  - 功能概述
  - 业务逻辑详解
  - 使用方法（批处理/命令行）
  - 命令行参数说明
  - 处理流程
  - 常见问题解答
  - 注意事项

---

#### 4. `客户类型标记_文件说明.md`
**本文件**
- 说明所有新增文件的用途和关系

---

### 测试文件

#### 5. `test_marker.py`
**测试数据生成脚本**
- 功能：生成测试用的Excel文件
- 生成内容：
  - 50条2024年订单（老客户）
  - 30条2025年订单（老客户）
  - 20条2025年订单（新客户）
- 输出文件：`测试_租机登记表.xlsx`

**测试数据特点：**
- 模拟真实的订单结构
- 包含所有必需的列（C列日期、G列身份证、T列标记）
- 预设的客户身份证号，便于验证逻辑

---

#### 6. `test_run.bat`
**自动化测试批处理文件**
- 功能：一键完成测试流程
- 执行步骤：
  1. 运行 `test_marker.py` 生成测试数据
  2. 运行 `mark_customer_type.py` 处理测试数据
  3. 输出结果到 `测试结果.xlsx`

---

## 📊 文件关系图

```
客户类型标记工具
│
├── 核心程序
│   ├── mark_customer_type.py    (主程序)
│   └── mark_customer.bat        (快捷启动)
│
├── 文档
│   ├── 客户类型标记说明.md      (使用说明)
│   └── 客户类型标记_文件说明.md (本文件)
│
└── 测试
    ├── test_marker.py           (测试数据生成)
    └── test_run.bat            (自动化测试)
```

---

## 🚀 使用流程

### 正式使用流程

```
1. 准备Excel文件
   └── 确保文件名为 "租机登记表.xlsx"
   └── 确保包含C列（日期）、G列（身份证）、T列（标记）

2. 运行工具
   └── 方式A: 双击 mark_customer.bat
   └── 方式B: 命令行运行 python mark_customer_type.py 租机登记表.xlsx

3. 查看结果
   └── 打开Excel文件
   └── 检查T列的标记和颜色
```

### 测试流程

```
1. 生成测试数据
   └── 双击 test_run.bat
   └── 或运行 python test_marker.py

2. 查看测试结果
   └── 打开 "测试结果.xlsx"
   └── 验证标记是否正确：
       - 2024年订单：全部为"存量"（黄色）
       - 2025年老客户：全部为"存量"（黄色）
       - 2025年新客户：全部为"新增"（绿色）
```

---

## 🎨 颜色代码

工具使用的颜色定义：

| 客户类型 | 颜色名称 | 十六进制代码 | 视觉效果 |
|---------|---------|-------------|---------|
| 新增客户 | 浅绿色 | `#C6EFCE` | 🟢 |
| 存量客户 | 浅黄色 | `#FFEB9C` | 🟡 |

---

## 📋 列索引对照表

| Excel列 | 列索引 | 用途 | 说明 |
|---------|--------|------|------|
| A列 | 0 | 序号 | - |
| B列 | 1 | 订单编号 | - |
| **C列** | **2** | **订单创建日期** | **关键列** |
| D列 | 3 | 客户姓名 | - |
| E列 | 4 | 联系电话 | - |
| F列 | 5 | 客户地址 | - |
| **G列** | **6** | **客户身份证号** | **关键列** |
| H-S列 | 7-18 | 其他信息 | - |
| **T列** | **19** | **客户类型标记** | **输出列** |

---

## ⚙️ 技术实现细节

### 依赖库
- `pandas`: 数据处理和Excel读取
- `openpyxl`: Excel文件操作和格式化
- `datetime`: 日期处理

### 核心算法
1. **数据加载**：使用pandas读取Excel，跳过第1行标题行
2. **客户识别**：通过身份证号（G列）识别唯一客户
3. **时间分析**：将订单日期与2025-01-01比较
4. **标记逻辑**：
   ```python
   if 订单日期 < 2025-01-01:
       标记 = "存量"
   else:
       if 身份证号 in 2025年之前的客户集合:
           标记 = "存量"
       else:
           标记 = "新增"
   ```
5. **格式应用**：使用openpyxl的PatternFill设置单元格背景色

---

## 🔧 自定义修改指南

### 修改颜色
编辑 `mark_customer_type.py` 中的颜色常量：
```python
class CustomerTypeMarker:
    COLOR_NEW_CUSTOMER = "C6EFCE"      # 新增客户颜色
    COLOR_EXISTING_CUSTOMER = "FFEB9C"  # 存量客户颜色
```

### 修改列位置
如果Excel文件的列位置不同，修改以下索引：
```python
def mark_customer_types(self):
    date_col_idx = 2   # C列 - 订单创建日期
    id_col_idx = 6     # G列 - 客户身份证号
    mark_col_idx = 19  # T列 - 客户类型标记
```

### 修改年份阈值
如果需要标记其他年份的新增客户：
```python
# 定义年份的起始日期
year_2025_start = pd.Timestamp('2025-01-01')
# 改为其他年份，例如：
year_2026_start = pd.Timestamp('2026-01-01')
```

---

## 📝 注意事项

1. **备份数据**：运行前建议备份原始Excel文件
2. **关闭文件**：处理前请关闭Excel文件
3. **编码问题**：批处理文件已设置UTF-8编码，避免中文乱码
4. **权限问题**：确保对文件有读写权限
5. **数据完整性**：确保C列和G列数据完整，避免空值

---

## 🆘 故障排除

### 问题1: 无法打开Excel文件
**解决方案**：
- 检查文件路径是否正确
- 确认文件名是否为 `租机登记表.xlsx`
- 关闭Excel程序后重试

### 问题2: 列验证失败
**解决方案**：
- 检查Excel文件是否有足够的列（至少20列）
- 确认第2行是表头行
- 查看工具输出的列名列表

### 问题3: 日期解析错误
**解决方案**：
- 确保C列是Excel日期格式
- 检查是否有非日期数据
- 尝试在Excel中重新格式化日期列

### 问题4: 保存失败
**解决方案**：
- 确认Excel文件未被其他程序打开
- 检查是否有写入权限
- 尝试使用 `-o` 参数保存到新文件

---

## 📞 技术支持

如需帮助，请提供以下信息：
1. 错误信息截图
2. Excel文件结构（列名和前几行数据）
3. 使用的命令或批处理文件
4. Python版本和依赖库版本

---

## 版本信息

- **版本**: v1.0.0
- **发布日期**: 2025-01-07
- **Python要求**: 3.7+
- **依赖**: pandas, openpyxl

---

**祝使用愉快！** 🎉

