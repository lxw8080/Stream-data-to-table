# Markdown流水转Excel工具

一个高度自由化和通用化的图形化CLI工具，用于将Markdown格式的交易流水记录转换为Excel表格。

## 功能特性

### 🚀 核心功能
- **智能解析**: 自动识别Markdown中的日期、交易记录等结构化信息
- **图形化界面**: 用户友好的GUI界面，操作简单直观
- **命令行支持**: 支持纯命令行模式，适合批处理和自动化
- **数据验证**: 内置数据验证功能，确保转换结果的准确性
- **多格式输出**: 生成Excel主表和多个汇总表

### 🛠️ 高度可定制
- **自定义字段映射**: 支持用户自定义正则表达式来解析特定字段
- **配置文件**: 支持YAML格式配置文件，可保存和重用设置
- **灵活的输出选项**: 可控制是否生成汇总表、自动调整列宽等
- **数据过滤**: 支持必填字段验证、金额格式验证等

### 📊 智能汇总
- **按日期汇总**: 自动统计每日交易笔数和总金额
- **按支付方式汇总**: 统计各种支付方式的使用情况
- **按客户汇总**: 统计每个客户的交易记录

## 安装和使用

### 1. 环境准备
```bash
# 安装Python依赖
pip install -r requirements.txt
```

### 2. GUI模式使用
```bash
python markdown_to_excel.py
```

### 3. 命令行模式使用
```bash
# 基本用法
python markdown_to_excel.py input.md --no-gui

# 指定输出文件
python markdown_to_excel.py input.md -o output.xlsx --no-gui

# 使用配置文件
python markdown_to_excel.py input.md -c config.yaml --no-gui

# 不生成汇总表
python markdown_to_excel.py input.md --no-summary --no-gui
```

## 支持的数据格式

工具能够解析以下Markdown格式的交易记录：

### 格式1：标准格式
```markdown
## 2025-09-09

### 客户姓名
姓名：张三；
交易笔数：第一笔；
交易金额：1000.00元；
交易日期：2025-09-09；
交易时间：09:16:15；
交易流水号/订单号/交易单号/流水号：ABC123456789；
支付方式：微信支付；
商户：某某商户；
备注：立码收收款；
```

### 格式2：标题行包含客户姓名 (v1.1新增)
```markdown
## 2025-09-10

### 客户姓名：张晋香
姓名：张晋香；
交易笔数：第一笔；
交易金额：2274.00元；
交易日期：2025-09-10；
交易时间：10:30:17；
交易流水号/订单号/交易单号/流水号：HPAY202509101030170015415243；
支付方式：协议支付；
商户：无；
备注：中国银行。
```

**智能姓名提取**: 工具会自动从以下格式的标题行提取客户姓名：
- `### 客户姓名：张三`
- `### 姓名：张三`
- `### 张三` (直接姓名)

## 配置选项详解

### 解析规则配置
```yaml
parsing_rules:
  date_pattern: "## (\\d{4}-\\d{2}-\\d{2})"  # 日期匹配模式
  header_name_extraction: true  # 启用从标题行提取姓名
  header_name_patterns:  # 标题行姓名提取模式 (按优先级排序)
    - "^客户姓名[：:]\\s*(.+?)(?:\\s|$)"
    - "^姓名[：:]\\s*(.+?)(?:\\s|$)"
    - "^(.+?)(?:\\s|$)"
  field_patterns:
    姓名: "姓名[：:]\\s*([^；;]+)"
    交易金额: "交易金额[：:]\\s*([^；;]+)"
    # 可添加更多自定义字段
```

### 输出设置
```yaml
output_settings:
  excel_filename: "转换结果_{timestamp}.xlsx"
  sheet_name: "交易记录"
  include_summary: true  # 是否包含汇总表
  auto_resize_columns: true  # 是否自动调整列宽
```

### 数据验证
```yaml
validation:
  required_fields: ["姓名", "交易金额"]  # 必填字段
  amount_validation: true  # 金额格式验证
  date_validation: true    # 日期格式验证
```

## GUI界面功能

### 主要功能区域
1. **文件选择**: 选择要转换的Markdown文件
2. **输出设置**: 设置输出目录和文件名
3. **配置选项**:
   - 包含汇总表
   - 自动调整列宽
   - 启用数据验证
   - 自定义字段正则表达式
4. **操作按钮**:
   - **预览数据**: 在转换前预览解析结果
   - **开始转换**: 执行转换操作
   - **保存配置**: 保存当前设置为配置文件
   - **加载配置**: 从文件加载配置设置

### 实时反馈
- 状态日志显示当前操作进度
- 进度条显示任务执行状态
- 数据预览窗口显示解析结果

## 输出Excel结构

### 主表 - "交易记录"
包含所有解析出的原始数据，字段包括：
- 日期
- 姓名
- 交易笔数
- 交易金额
- 交易时间
- 交易流水号
- 支付方式
- 商户
- 备注
- 金额数值（数值型，用于计算）

### 汇总表
1. **按日期汇总**: 每日交易笔数和总金额
2. **按支付方式汇总**: 各支付方式统计
3. **按客户汇总**: 每个客户的交易统计

## 自定义字段扩展

如果您的Markdown文档包含其他字段，可以通过以下方式添加：

### 方法1: GUI界面自定义
在"自定义字段正则"文本框中添加YAML格式的字段定义：
```yaml
新字段名: "新字段名[：:]\\s*([^；;]+)"
产品名称: "产品[：:]\\s*([^；;]+)"
```

### 方法2: 配置文件
创建或编辑配置文件，在`field_patterns`中添加新字段：
```yaml
parsing_rules:
  field_patterns:
    姓名: "姓名[：:]\\s*([^；;]+)"
    # ... 其他字段
    自定义字段: "自定义字段[：:]\\s*([^；;]+)"
```

## 错误处理和故障排除

### 常见问题

1. **无法解析数据**
   - 检查Markdown格式是否正确
   - 确认日期格式为 `## YYYY-MM-DD`
   - 验证字段分隔符（使用分号 `;` 或 `；`）

2. **字段缺失**
   - 检查字段名称是否匹配正则表达式
   - 尝试自定义字段正则表达式
   - 查看状态日志了解具体错误

3. **Excel生成失败**
   - 确保有写入权限
   - 检查输出路径是否存在
   - 确认Excel文件未被其他程序占用

### 调试技巧
1. 使用"预览数据"功能检查解析结果
2. 查看状态日志获取详细错误信息
3. 尝试简化输入数据进行测试

## 技术实现

### 核心技术栈
- **Python 3.7+**: 主要编程语言
- **tkinter**: GUI界面框架
- **pandas**: 数据处理和Excel生成
- **openpyxl**: Excel文件操作
- **PyYAML**: 配置文件处理
- **正则表达式**: 文本解析

### 架构设计
- **MarkdownToExcelConverter**: 核心转换逻辑
- **MarkdownToExcelGUI**: 图形用户界面
- **配置系统**: 灵活的配置管理
- **数据验证**: 多层次的数据校验

## 版本信息

- **当前版本**: v1.0
- **发布日期**: 2025-09-20
- **兼容性**: Python 3.7+, Windows/macOS/Linux

## 许可证

MIT License - 详见LICENSE文件

## 贡献和反馈

欢迎提交Issue和Pull Request来改进这个工具！

---

**提示**: 第一次使用建议先用"预览数据"功能检查解析效果，确认无误后再进行正式转换。